<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sailing Flash-cards – Spaced Review</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- reset link -->
<a id="resetLink" class="reset-link" href="#">Reset</a>

  <main class="card">
    <h2 id="question">Loading question…</h2>
    <p id="bucketInfo" class="bucket"></p>

    <ul id="answers" class="answers"></ul>
    <p id="result" class="result"></p>

    <div class="buttons">
      <button id="checkBtn">Check</button>
      <button id="nextBtn">Next</button>
    </div>

    <!-- NEW: bucket statistics -->
    <p id="stats" class="stats"></p>
  </main>

  <script>
    /* ---------- constants & helpers ---------- */
    const MAX_BUCKET = 5;
    const STORAGE_KEY = 'bucketMap';

    const qs   = (sel) => document.querySelector(sel);
    const qsa  = (sel) => document.querySelectorAll(sel);

    function shuffle(a) {          // Fisher-Yates
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
    }

    /* ---------- Leitner storage (localStorage) ---------- */
    function loadBuckets()          { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    function bucketOf(id)           { return loadBuckets()[id] || 1; }
    function setBucket(id, bucket)  {
      const map  = loadBuckets();
      map[id]    = bucket;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(map));
    }
    function clearBuckets()         { localStorage.removeItem(STORAGE_KEY); }

    /* ---------- state ---------- */
    let allQ = [];
    let current = null;

    function pickRandom() { return allQ[Math.floor(Math.random() * allQ.length)]; }

    /* ---------- stats line ---------- */
    function updateStats() {
      const map   = loadBuckets();
      const total = allQ.length;
      const pieces = [];

      for (let b = 1; b <= MAX_BUCKET; b++) {
        const count = allQ.filter(q => bucketOf(q.id) === b).length;
        const percent = Math.round((count / total) * 100) || 0;
        pieces.push(`Bucket ${b}: ${count} (${percent}%)`);
      }
      qs('#stats').innerHTML = pieces.join('<br>');
    }

    /* ---------- UI ---------- */
    function renderQuestion(q) {
      qs('#question').textContent = q.question;
      qs('#result').textContent  = '';
      qs('#bucketInfo').textContent = `Bucket ${bucketOf(q.id)}`;

      const ul = qs('#answers');
      ul.innerHTML = '';

      const keys = ['answer_1', 'answer_2', 'answer_3'];
      shuffle(keys);

      keys.forEach(k => {
        const idx = Number(k.slice(-1));      // 1–3
        const li = document.createElement('li');
        li.innerHTML = `
          <label>
            <input type="radio" name="answer" value="${idx}">
            <span>${q[k]}</span>
          </label>`;
        ul.appendChild(li);
      });
    }

    /* ---------- event handlers ---------- */
    qs('#answers').addEventListener('click', e => {
      const li = e.target.closest('li');
      if (li) li.querySelector('input[type="radio"]').checked = true;
    });

    qs('#checkBtn').addEventListener('click', () => {
      const chosenInput = qs('input[name="answer"]:checked');
      if (!chosenInput) return;                    // nothing selected

      const chosen  = Number(chosenInput.value);
      const correct = chosen === current.correct_answer;

      /* move card */
      const now   = bucketOf(current.id);
      const nextB = Math.max(1, Math.min(MAX_BUCKET, correct ? now + 1 : now - 1));
      setBucket(current.id, nextB);
      qs('#bucketInfo').textContent = `Bucket ${nextB}`;

      /* colour rows */
      qsa('input[name="answer"]').forEach(inp => {
        const li  = inp.parentElement.parentElement;
        li.classList.remove('correct','incorrect');
        const idx = Number(inp.value);
        if (idx === current.correct_answer) li.classList.add('correct');
        else if (idx === chosen)            li.classList.add('incorrect');
      });

      qs('#result').textContent = correct ? 'CORRECT ✅' : 'WRONG ❌';
      updateStats();
    });

    qs('#nextBtn').addEventListener('click', () => {
      current = pickRandom();
      renderQuestion(current);
    });

    /* reset progress */
    qs('#resetLink').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Clear all progress and start over?')) {
        clearBuckets();
        updateStats();
        renderQuestion(current);   // refresh bucket info on current card
      }
    });

    /* ---------- boot ---------- */
    fetch('questions.json')
      .then(r => r.json())
      .then(data => {
        allQ   = data;
        current = pickRandom();
        renderQuestion(current);
        updateStats();
      })
      .catch(err => {
        qs('#question').textContent = 'Failed to load questions.json';
        console.error(err);
      });
  </script>
</body>
</html>
